/**
 * æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒæ¨¡çµ„
 * è² è²¬æ‡‰ç”¨ç¨‹å¼çš„æ•´é«”é‚è¼¯å’Œå”èª¿å„å€‹æ¨¡çµ„
 */

import { APP_CONFIG, EVENT_TYPES } from '../config/settings.js';
import { domUtils, eventUtils, performanceUtils } from './utils.js';
import TaskManager from '../components/TaskManager.js';

/**
 * æ‡‰ç”¨ç¨‹å¼é¡žåˆ¥
 */
class App {
    constructor() {
        this.isInitialized = false;
        this.isRunning = false;
        this.taskManager = null;
        this.modules = {};

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        this.state = {
            version: APP_CONFIG.version,
            startTime: null,
            lastActivity: null,
            errorCount: 0,
            isOnline: navigator.onLine,
        };

        // ç¹«çµæ–¹æ³•
        this.handleOnline = this.handleOnline.bind(this);
        this.handleOffline = this.handleOffline.bind(this);
        this.handleVisibilityChange = this.handleVisibilityChange.bind(this);
        this.handleBeforeUnload = this.handleBeforeUnload.bind(this);
        this.handleError = this.handleError.bind(this);
    }

    /**
     * åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
     */
    async initialize() {
        try {
            console.log('ðŸš€ æ­£åœ¨åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');

            // æª¢æŸ¥ç’°å¢ƒ
            this.checkEnvironment();

            // åˆå§‹åŒ–ç‹€æ…‹
            this.state.startTime = new Date();
            this.state.lastActivity = new Date();

            // è¨»å†Šå…¨åŸŸäº‹ä»¶ç›£è½å™¨
            this.registerGlobalEventListeners();

            // åˆå§‹åŒ–å„å€‹æ¨¡çµ„
            await this.initializeModules();

            // è¨­å®šè‡ªå‹•å„²å­˜
            this.setupAutoSave();

            // è¨­å®šæ•ˆèƒ½ç›£æŽ§
            this.setupPerformanceMonitoring();

            // è¨­å®šéŒ¯èª¤è™•ç†
            this.setupErrorHandling();

            // ç™¼å°„åˆå§‹åŒ–å®Œæˆäº‹ä»¶
            this.emitEvent(EVENT_TYPES.APP_READY, {
                version: this.state.version,
                modules: Object.keys(this.modules),
            });

            this.isInitialized = true;
            this.isRunning = true;

            console.log('âœ… æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('âŒ æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:', error);
            this.handleCriticalError(error);
            throw error;
        }
    }

    /**
     * æª¢æŸ¥åŸ·è¡Œç’°å¢ƒ
     */
    checkEnvironment() {
        // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
        const requiredFeatures = [
            'localStorage',
            'querySelector',
            'addEventListener',
            'Promise',
            'fetch',
        ];

        const missingFeatures = requiredFeatures.filter(feature => {
            switch (feature) {
                case 'localStorage':
                    return typeof Storage === 'undefined';
                case 'querySelector':
                    return !document.querySelector;
                case 'addEventListener':
                    return !document.addEventListener;
                case 'Promise':
                    return typeof Promise === 'undefined';
                case 'fetch':
                    return typeof fetch === 'undefined';
                default:
                    return false;
            }
        });

        if (missingFeatures.length > 0) {
            throw new Error(`ç€è¦½å™¨ä¸æ”¯æ´ä»¥ä¸‹åŠŸèƒ½: ${missingFeatures.join(', ')}`);
        }

        // æª¢æŸ¥æœ¬åœ°å„²å­˜å¯ç”¨æ€§
        this.testLocalStorage();

        console.log('ðŸ” ç’°å¢ƒæª¢æŸ¥é€šéŽ');
    }

    /**
     * æ¸¬è©¦æœ¬åœ°å„²å­˜
     */
    testLocalStorage() {
        try {
            const testKey = '__localStorage_test__';
            localStorage.setItem(testKey, 'test');
            localStorage.removeItem(testKey);
        } catch (error) {
            throw new Error('æœ¬åœ°å„²å­˜ä¸å¯ç”¨ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š');
        }
    }

    /**
     * è¨»å†Šå…¨åŸŸäº‹ä»¶ç›£è½å™¨
     */
    registerGlobalEventListeners() {
        // ç¶²è·¯ç‹€æ…‹è®Šæ›´
        eventUtils.on(window, 'online', this.handleOnline);
        eventUtils.on(window, 'offline', this.handleOffline);

        // é é¢å¯è¦‹æ€§è®Šæ›´
        eventUtils.on(document, 'visibilitychange', this.handleVisibilityChange);

        // é é¢å¸è¼‰å‰
        eventUtils.on(window, 'beforeunload', this.handleBeforeUnload);

        // éŒ¯èª¤è™•ç†
        eventUtils.on(window, 'error', this.handleError);
        eventUtils.on(window, 'unhandledrejection', this.handleUnhandledRejection);

        console.log('ðŸ“¡ å…¨åŸŸäº‹ä»¶ç›£è½å™¨å·²è¨»å†Š');
    }

    /**
     * åˆå§‹åŒ–å„å€‹æ¨¡çµ„
     */
    async initializeModules() {
        console.log('ðŸ”§ æ­£åœ¨åˆå§‹åŒ–æ¨¡çµ„...');

        try {
            // å–å¾—æ‡‰ç”¨ç¨‹å¼å®¹å™¨
            const appContainer = domUtils.query('#app');
            if (!appContainer) {
                throw new Error('æ‰¾ä¸åˆ°æ‡‰ç”¨ç¨‹å¼å®¹å™¨ #app');
            }

            // åˆå§‹åŒ–ä»»å‹™ç®¡ç†å™¨
            this.taskManager = new TaskManager(appContainer);
            this.modules.taskManager = this.taskManager;

            console.log('âœ… æ‰€æœ‰æ¨¡çµ„åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('æ¨¡çµ„åˆå§‹åŒ–å¤±æ•—:', error);
            throw error;
        }
    }

    /**
     * è¨­å®šè‡ªå‹•å„²å­˜
     */
    setupAutoSave() {
        if (!APP_CONFIG.features.autoSave.enabled) return;

        const autoSaveFunction = performanceUtils.debounce(() => {
            this.performAutoSave();
        }, APP_CONFIG.features.autoSave.debounce);

        // ç›£è½è³‡æ–™è®Šæ›´äº‹ä»¶
        eventUtils.on(window, EVENT_TYPES.TODO_ADDED, autoSaveFunction);
        eventUtils.on(window, EVENT_TYPES.TODO_UPDATED, autoSaveFunction);
        eventUtils.on(window, EVENT_TYPES.TODO_DELETED, autoSaveFunction);
        eventUtils.on(window, EVENT_TYPES.TODO_COMPLETED, autoSaveFunction);
        eventUtils.on(window, EVENT_TYPES.TODO_UNCOMPLETED, autoSaveFunction);

        console.log('ðŸ’¾ è‡ªå‹•å„²å­˜å·²è¨­å®š');
    }

    /**
     * åŸ·è¡Œè‡ªå‹•å„²å­˜
     */
    async performAutoSave() {
        try {
            // æ¨¡çµ„å·²è‡ªå‹•è™•ç†å„²å­˜ï¼Œé€™è£¡å¯ä»¥åŸ·è¡Œé¡å¤–é‚è¼¯
            console.log('ðŸ”„ è‡ªå‹•å„²å­˜å®Œæˆ');
        } catch (error) {
            console.error('è‡ªå‹•å„²å­˜å¤±æ•—:', error);
        }
    }

    /**
     * è¨­å®šæ•ˆèƒ½ç›£æŽ§
     */
    setupPerformanceMonitoring() {
        if (!APP_CONFIG.development.performanceMonitoring.enabled) return;

        // ç›£æŽ§é é¢è¼‰å…¥æ™‚é–“
        if (performance.timing) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    this.logPerformanceMetrics();
                }, 0);
            });
        }

        console.log('ðŸ“Š æ•ˆèƒ½ç›£æŽ§å·²è¨­å®š');
    }

    /**
     * è¨˜éŒ„æ•ˆèƒ½æŒ‡æ¨™
     */
    logPerformanceMetrics() {
        if (!performance.timing) return;

        const timing = performance.timing;
        const metrics = {
            // ç¶²è·¯æ™‚é–“
            dnsLookup: timing.domainLookupEnd - timing.domainLookupStart,
            tcpConnect: timing.connectEnd - timing.connectStart,
            request: timing.responseStart - timing.requestStart,
            response: timing.responseEnd - timing.responseStart,

            // è™•ç†æ™‚é–“
            domProcessing: timing.domContentLoadedEventStart - timing.domLoading,
            domComplete: timing.domComplete - timing.domLoading,

            // ç¸½æ™‚é–“
            totalTime: timing.loadEventEnd - timing.navigationStart,
        };

        console.log('ðŸ“ˆ æ•ˆèƒ½æŒ‡æ¨™:', metrics);
    }

    /**
     * è¨­å®šéŒ¯èª¤è™•ç†
     */
    setupErrorHandling() {
        // è¨­å®šå…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', this.handleError);
        window.addEventListener('unhandledrejection', this.handleUnhandledRejection);

        console.log('ðŸ›¡ï¸ éŒ¯èª¤è™•ç†å·²è¨­å®š');
    }

    /**
     * è™•ç†ç·šä¸Šç‹€æ…‹
     */
    handleOnline() {
        this.state.isOnline = true;
        this.state.lastActivity = new Date();

        console.log('ðŸŒ ç¶²è·¯å·²é€£ç·š');
        this.showNotification('ç¶²è·¯å·²é€£ç·š', 'success');

        // é‡æ–°åŒæ­¥è³‡æ–™
        this.syncData();
    }

    /**
     * è™•ç†é›¢ç·šç‹€æ…‹
     */
    handleOffline() {
        this.state.isOnline = false;
        this.state.lastActivity = new Date();

        console.log('ðŸ“¡ ç¶²è·¯å·²æ–·ç·š');
        this.showNotification('ç¶²è·¯å·²æ–·ç·šï¼Œæ‡‰ç”¨ç¨‹å¼å°‡åœ¨é›¢ç·šæ¨¡å¼ä¸‹é‹ä½œ', 'warning');
    }

    /**
     * è™•ç†é é¢å¯è¦‹æ€§è®Šæ›´
     */
    handleVisibilityChange() {
        this.state.lastActivity = new Date();

        if (document.hidden) {
            console.log('ðŸ‘ï¸ é é¢å·²éš±è—');
            // é é¢éš±è—æ™‚å¯ä»¥åŸ·è¡Œæ¸…ç†å·¥ä½œ
        } else {
            console.log('ðŸ‘ï¸ é é¢å·²é¡¯ç¤º');
            // é é¢é¡¯ç¤ºæ™‚å¯ä»¥é‡æ–°æ•´ç†è³‡æ–™
            this.refreshData();
        }
    }

    /**
     * è™•ç†é é¢å¸è¼‰å‰äº‹ä»¶
     */
    handleBeforeUnload(event) {
        // æª¢æŸ¥æ˜¯å¦æœ‰æœªå„²å­˜çš„è®Šæ›´
        if (this.hasUnsavedChanges()) {
            event.preventDefault();
            event.returnValue = 'æ‚¨æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œç¢ºå®šè¦é›¢é–‹å—Žï¼Ÿ';
        }
    }

    /**
     * è™•ç†éŒ¯èª¤
     */
    handleError(event) {
        this.state.errorCount++;
        this.state.lastActivity = new Date();

        const error = {
            message: event.message,
            filename: event.filename,
            lineno: event.lineno,
            colno: event.colno,
            timestamp: new Date().toISOString(),
        };

        console.error('âŒ æ‡‰ç”¨ç¨‹å¼éŒ¯èª¤:', error);

        // é¡¯ç¤ºéŒ¯èª¤é€šçŸ¥
        this.showNotification('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');

        // è¨˜éŒ„éŒ¯èª¤
        this.logError(error);
    }

    /**
     * è™•ç†æœªè™•ç†çš„ Promise æ‹’çµ•
     */
    handleUnhandledRejection(event) {
        this.state.errorCount++;
        this.state.lastActivity = new Date();

        const error = {
            reason: event.reason,
            timestamp: new Date().toISOString(),
        };

        console.error('âŒ æœªè™•ç†çš„ Promise æ‹’çµ•:', error);

        // é¡¯ç¤ºéŒ¯èª¤é€šçŸ¥
        this.showNotification('ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤', 'error');

        // è¨˜éŒ„éŒ¯èª¤
        this.logError(error);
    }

    /**
     * è™•ç†é—œéµéŒ¯èª¤
     */
    handleCriticalError(error) {
        console.error('ðŸ’¥ é—œéµéŒ¯èª¤:', error);

        // å˜—è©¦é¡¯ç¤ºéŒ¯èª¤é é¢
        this.showErrorPage(error);

        // åœæ­¢æ‡‰ç”¨ç¨‹å¼
        this.stop();
    }

    /**
     * é¡¯ç¤ºéŒ¯èª¤é é¢
     */
    showErrorPage(error) {
        const app = domUtils.query('#app');
        if (!app) return;

        const errorPage = domUtils.createElement('div', { className: 'error-page' });

        const title = domUtils.createElement('h1');
        title.textContent = 'æ‡‰ç”¨ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤';
        errorPage.appendChild(title);

        const message = domUtils.createElement('p');
        message.textContent = error.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤';
        errorPage.appendChild(message);

        const retryBtn = domUtils.createElement('button');
        retryBtn.textContent = 'é‡æ–°è¼‰å…¥';
        retryBtn.addEventListener('click', () => {
            window.location.reload();
        });
        errorPage.appendChild(retryBtn);

        app.textContent = '';
        app.appendChild(errorPage);
    }

    /**
     * åŒæ­¥è³‡æ–™
     */
    async syncData() {
        try {
            console.log('ðŸ”„ æ­£åœ¨åŒæ­¥è³‡æ–™...');
            // é€™è£¡å¯ä»¥å¯¦ç¾èˆ‡ä¼ºæœå™¨çš„åŒæ­¥é‚è¼¯
        } catch (error) {
            console.error('åŒæ­¥è³‡æ–™å¤±æ•—:', error);
        }
    }

    /**
     * é‡æ–°æ•´ç†è³‡æ–™
     */
    async refreshData() {
        try {
            console.log('ðŸ”„ æ­£åœ¨é‡æ–°æ•´ç†è³‡æ–™...');
            this.modules.ui.render();
        } catch (error) {
            console.error('é‡æ–°æ•´ç†è³‡æ–™å¤±æ•—:', error);
        }
    }

    /**
     * æª¢æŸ¥æ˜¯å¦æœ‰æœªå„²å­˜çš„è®Šæ›´
     */
    hasUnsavedChanges() {
        // é€™è£¡å¯ä»¥å¯¦ç¾æª¢æŸ¥é‚è¼¯
        return false;
    }

    /**
     * è¨˜éŒ„éŒ¯èª¤
     */
    logError(error) {
        // é€™è£¡å¯ä»¥å¯¦ç¾éŒ¯èª¤è¨˜éŒ„é‚è¼¯ï¼Œä¾‹å¦‚ç™¼é€åˆ°åˆ†æžæœå‹™
        if (APP_CONFIG.development.debug) {
            console.error('éŒ¯èª¤è©³æƒ…:', error);
        }
    }

    /**
     * ç™¼å°„äº‹ä»¶
     */
    emitEvent(eventName, detail = null) {
        eventUtils.emit(document, eventName, detail);
    }

    /**
     * ç›£è½äº‹ä»¶
     */
    onEvent(eventName, handler) {
        return eventUtils.on(document, eventName, handler);
    }

    /**
     * é¡¯ç¤ºé€šçŸ¥
     */
    showNotification(message, type = 'info') {
        if (this.modules.ui) {
            this.modules.ui.showNotification(message, type);
        }
    }

    /**
     * å–å¾—æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
     */
    getState() {
        return {
            ...this.state,
            isInitialized: this.isInitialized,
            isRunning: this.isRunning,
            uptime: this.state.startTime ? Date.now() - this.state.startTime.getTime() : 0,
            modules: Object.keys(this.modules),
        };
    }

    /**
     * å–å¾—æ‡‰ç”¨ç¨‹å¼è³‡è¨Š
     */
    getInfo() {
        return {
            name: APP_CONFIG.name,
            version: APP_CONFIG.version,
            description: APP_CONFIG.description,
            author: APP_CONFIG.author,
            environment: {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                online: navigator.onLine,
                cookieEnabled: navigator.cookieEnabled,
            },
        };
    }

    /**
     * é‡å•Ÿæ‡‰ç”¨ç¨‹å¼
     */
    async restart() {
        console.log('ðŸ”„ æ­£åœ¨é‡å•Ÿæ‡‰ç”¨ç¨‹å¼...');

        try {
            await this.stop();
            await this.initialize();
            console.log('âœ… æ‡‰ç”¨ç¨‹å¼é‡å•Ÿå®Œæˆ');
        } catch (error) {
            console.error('âŒ æ‡‰ç”¨ç¨‹å¼é‡å•Ÿå¤±æ•—:', error);
            throw error;
        }
    }

    /**
     * åœæ­¢æ‡‰ç”¨ç¨‹å¼
     */
    async stop() {
        console.log('ðŸ›‘ æ­£åœ¨åœæ­¢æ‡‰ç”¨ç¨‹å¼...');

        try {
            this.isRunning = false;

            // åŸ·è¡Œæœ€å¾Œä¸€æ¬¡è‡ªå‹•å„²å­˜
            if (APP_CONFIG.features.autoSave.enabled) {
                await this.performAutoSave();
            }

            // éŠ·æ¯€æ¨¡çµ„
            await this.destroyModules();

            // ç§»é™¤äº‹ä»¶ç›£è½å™¨
            this.removeGlobalEventListeners();

            console.log('âœ… æ‡‰ç”¨ç¨‹å¼å·²åœæ­¢');
        } catch (error) {
            console.error('âŒ åœæ­¢æ‡‰ç”¨ç¨‹å¼å¤±æ•—:', error);
            throw error;
        }
    }

    /**
     * éŠ·æ¯€æ¨¡çµ„
     */
    async destroyModules() {
        for (const [name, module] of Object.entries(this.modules)) {
            try {
                if (typeof module.destroy === 'function') {
                    await module.destroy();
                }
                console.log(`âœ… æ¨¡çµ„ ${name} å·²éŠ·æ¯€`);
            } catch (error) {
                console.error(`âŒ éŠ·æ¯€æ¨¡çµ„ ${name} å¤±æ•—:`, error);
            }
        }
    }

    /**
     * ç§»é™¤å…¨åŸŸäº‹ä»¶ç›£è½å™¨
     */
    removeGlobalEventListeners() {
        window.removeEventListener('online', this.handleOnline);
        window.removeEventListener('offline', this.handleOffline);
        document.removeEventListener('visibilitychange', this.handleVisibilityChange);
        window.removeEventListener('beforeunload', this.handleBeforeUnload);
        window.removeEventListener('error', this.handleError);
        window.removeEventListener('unhandledrejection', this.handleUnhandledRejection);

        console.log('ðŸ“¡ å…¨åŸŸäº‹ä»¶ç›£è½å™¨å·²ç§»é™¤');
    }

    /**
     * åŸ·è¡Œå¥åº·æª¢æŸ¥
     */
    async healthCheck() {
        try {
            const checks = {
                localStorage: this.checkLocalStorage(),
                modules: this.checkModules(),
                dom: this.checkDOM(),
                events: this.checkEvents(),
            };

            const isHealthy = Object.values(checks).every(check => check);

            return {
                healthy: isHealthy,
                checks,
                timestamp: new Date().toISOString(),
            };
        } catch (error) {
            console.error('å¥åº·æª¢æŸ¥å¤±æ•—:', error);
            return {
                healthy: false,
                error: error.message,
                timestamp: new Date().toISOString(),
            };
        }
    }

    /**
     * æª¢æŸ¥æœ¬åœ°å„²å­˜
     */
    checkLocalStorage() {
        try {
            const testKey = '__health_check__';
            localStorage.setItem(testKey, 'test');
            localStorage.removeItem(testKey);
            return true;
        } catch {
            return false;
        }
    }

    /**
     * æª¢æŸ¥æ¨¡çµ„
     */
    checkModules() {
        return Object.values(this.modules).every(module => {
            return module && typeof module === 'object';
        });
    }

    /**
     * æª¢æŸ¥ DOM
     */
    checkDOM() {
        return !!(document && document.querySelector);
    }

    /**
     * æª¢æŸ¥äº‹ä»¶ç³»çµ±
     */
    checkEvents() {
        return !!(document && document.addEventListener && document.dispatchEvent);
    }
}

// å»ºç«‹ä¸¦åŒ¯å‡ºå–®ä¾‹å¯¦ä¾‹
const app = new App();

export default app;