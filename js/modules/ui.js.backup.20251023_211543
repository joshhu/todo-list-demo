/**
 * UI ÁÆ°ÁêÜÊ®°ÁµÑ
 *
 * Ë≤†Ë≤¨ÁÆ°ÁêÜÊáâÁî®Á®ãÂºèÁöÑÁî®Êà∂ÁïåÈù¢ÔºåÂåÖÊã¨Ôºö
 * - DOM ÂÖÉÁ¥†ÁÆ°ÁêÜ
 * - ‰∫ã‰ª∂ËôïÁêÜ
 * - ÁµÑ‰ª∂Ê∏≤Êüì
 * - Áî®Êà∂‰∫§‰∫í
 * - Ë¶ñÂúñÊõ¥Êñ∞
 */

export class UI {
  constructor(settings, utils) {
    this.settings = settings;
    this.utils = utils;
    this.elements = {};
    this.components = {};
    this.listeners = new Map();
    this.currentFilter = 'all';
    this.currentSort = 'created-desc';
    this.searchQuery = '';
    this.selectedTasks = new Set();
    this.storage = null; // Â∞áÂú® initStorage ‰∏≠Ë®≠ÁΩÆ
  }

  /**
   * ÂàùÂßãÂåñ UI Ê®°ÁµÑ
   */
  async initialize() {
    try {
      // Âø´Âèñ DOM ÂÖÉÁ¥†
      this.cacheElements();

      // ÂàùÂßãÂåñÁµÑ‰ª∂
      this.initializeComponents();

      // Á∂ÅÂÆö‰∫ã‰ª∂Áõ£ËÅΩÂô®
      this.bindEventListeners();

      // ÊáâÁî®ÂàùÂßãË®≠ÂÆö
      this.applyInitialSettings();

      // Áõ£ËÅΩË®≠ÂÆöËÆäÊõ¥
      this.bindSettingsListeners();

      console.log('‚úÖ UI Ê®°ÁµÑÂàùÂßãÂåñÂÆåÊàê');
    } catch (error) {
      console.error('‚ùå UI Ê®°ÁµÑÂàùÂßãÂåñÂ§±Êïó:', error);
      throw error;
    }
  }

  /**
   * Âø´ÂèñÂ∏∏Áî®ÁöÑ DOM ÂÖÉÁ¥†
   */
  cacheElements() {
    this.elements = {
      // Ë°®ÂñÆÂÖÉÁ¥†
      taskForm: document.getElementById('taskForm'),
      titleInput: document.getElementById('taskTitle'),
      descriptionInput: document.getElementById('taskDescription'),
      prioritySelect: document.getElementById('taskPriority'),
      dueDateInput: document.getElementById('taskDueDate'),
      tagsInput: document.getElementById('taskTags'),
      addTaskBtn: document.getElementById('addTaskBtn'),
      clearFormBtn: document.getElementById('clearFormBtn'),

      // ÊéßÂà∂ÂÖÉÁ¥†
      searchInput: document.getElementById('searchInput'),
      searchClearBtn: document.getElementById('searchClearBtn'),
      sortSelect: document.getElementById('sortSelect'),
      filterButtons: document.querySelectorAll('.filter-btn'),
      viewButtons: document.querySelectorAll('.view-btn'),

      // ÂàóË°®ÂÖÉÁ¥†
      taskList: document.getElementById('taskList'),
      taskListContainer: document.getElementById('taskListContainer'),
      emptyState: document.getElementById('emptyState'),
      noResults: document.getElementById('noResults'),

      // Áµ±Ë®àÂÖÉÁ¥†
      totalTasksCount: document.getElementById('totalTasksCount'),
      completedTasksCount: document.getElementById('completedTasksCount'),

      // ÁØ©ÈÅ∏Ë®àÊï∏ÂÖÉÁ¥†
      filterCounts: {
        all: document.querySelector('[data-count="all"]'),
        active: document.querySelector('[data-count="active"]'),
        completed: document.querySelector('[data-count="completed"]')
      },

      // ÊâπÈáèÊìç‰ΩúÂÖÉÁ¥†
      bulkActions: document.getElementById('bulkActions'),
      selectedCount: document.getElementById('selectedCount'),
      selectAllBtn: document.getElementById('selectAllBtn'),
      markCompleteBtn: document.getElementById('markCompleteBtn'),
      deleteSelectedBtn: document.getElementById('deleteSelectedBtn'),

      // Ê®°ÊÖãÊ°ÜÂÖÉÁ¥†
      confirmModal: document.getElementById('confirmModal'),
      confirmModalTitle: document.getElementById('confirmModalTitle'),
      confirmModalDescription: document.getElementById('confirmModalDescription'),
      confirmModalCancel: document.getElementById('confirmModalCancel'),
      confirmModalConfirm: document.getElementById('confirmModalConfirm'),

      // ÈÄöÁü•ÂÆπÂô®
      notificationContainer: document.getElementById('notificationContainer'),

      // ËºâÂÖ•ÊåáÁ§∫Âô®
      loadingOverlay: document.getElementById('loadingOverlay'),

      // Á©∫ÁãÄÊÖãÊåâÈàï
      emptyStateAddBtn: document.getElementById('emptyStateAddBtn')
    };
  }

  /**
   * ÂàùÂßãÂåñÁµÑ‰ª∂
   */
  initializeComponents() {
    // ÂàùÂßãÂåñ‰ªªÂãôËº∏ÂÖ•ÁµÑ‰ª∂
    this.components.taskInput = new TaskInput(this.elements, this.utils);

    // ÂàùÂßãÂåñ‰ªªÂãôÂàóË°®ÁµÑ‰ª∂
    this.components.taskList = new TaskList(this.elements, this.utils);

    // ÂàùÂßãÂåñÊéßÂà∂ÁµÑ‰ª∂
    this.components.controls = new Controls(this.elements, this.utils);

    // ÂàùÂßãÂåñÈÄöÁü•ÁµÑ‰ª∂
    this.components.notifications = new Notifications(this.elements.notificationContainer);

    // ÂàùÂßãÂåñÁãÄÊÖãÁÆ°ÁêÜÂô®ÔºàÂ¶ÇÊûúÂÑ≤Â≠òÊ®°ÁµÑÂ∑≤Á∂ìÂèØÁî®Ôºâ
    if (this.storage) {
      this.initializeStatusManager();
      this.initializeProgressTracker();
      this.initializeEditingComponents();
    }
  }

  /**
   * Ë®≠ÁΩÆÂÑ≤Â≠òÊ®°ÁµÑÂºïÁî®
   */
  setStorage(storage) {
    this.storage = storage;

    // Â¶ÇÊûúÁµÑ‰ª∂Â∑≤Á∂ìÂàùÂßãÂåñÔºåÁèæÂú®ÂàùÂßãÂåñÁãÄÊÖãÁÆ°ÁêÜÂô®
    if (this.components.taskInput) {
      this.initializeStatusManager();
      this.initializeProgressTracker();
    }
  }

  /**
   * ÂàùÂßãÂåñÁãÄÊÖãÁÆ°ÁêÜÂô®
   */
  initializeStatusManager() {
    if (!this.storage) return;

    // ÂãïÊÖãÂ∞éÂÖ•ÁãÄÊÖãÁÆ°ÁêÜÂô®
    import('../components/status-manager.js').then(({ StatusManager }) => {
      this.components.statusManager = new StatusManager(this.elements, this.utils, this.storage);
      this.components.statusManager.initialize().catch(error => {
        console.error('ÂàùÂßãÂåñÁãÄÊÖãÁÆ°ÁêÜÂô®Â§±Êïó:', error);
      });
    }).catch(error => {
      console.error('ËºâÂÖ•ÁãÄÊÖãÁÆ°ÁêÜÂô®Â§±Êïó:', error);
    });
  }

  /**
   * ÂàùÂßãÂåñÈÄ≤Â∫¶ËøΩËπ§Âô®
   */
  initializeProgressTracker() {
    if (!this.storage) return;

    // ÂãïÊÖãÂ∞éÂÖ•ÈÄ≤Â∫¶ËøΩËπ§Âô®
    import('../components/progress-tracker.js').then(({ ProgressTracker }) => {
      this.components.progressTracker = new ProgressTracker(this.elements, this.utils, this.storage);
      this.components.progressTracker.initialize().catch(error => {
        console.error('ÂàùÂßãÂåñÈÄ≤Â∫¶ËøΩËπ§Âô®Â§±Êïó:', error);
      });
    }).catch(error => {
      console.error('ËºâÂÖ•ÈÄ≤Â∫¶ËøΩËπ§Âô®Â§±Êïó:', error);
    });
  }

  /**
   * Á∂ÅÂÆö‰∫ã‰ª∂Áõ£ËÅΩÂô®
   */
  bindEventListeners() {
    // ‰ªªÂãôË°®ÂñÆ‰∫ã‰ª∂
    this.bindFormEvents();

    // ÊêúÂ∞ãÂíåÁØ©ÈÅ∏‰∫ã‰ª∂
    this.bindSearchEvents();
    this.bindFilterEvents();
    this.bindSortEvents();

    // ÊâπÈáèÊìç‰Ωú‰∫ã‰ª∂
    this.bindBulkActionEvents();

    // Ê®°ÊÖãÊ°Ü‰∫ã‰ª∂
    this.bindModalEvents();

    // ÈçµÁõ§Âø´Êç∑Èçµ
    this.bindKeyboardEvents();

    // Ë¶ñÂúñÂàáÊèõ‰∫ã‰ª∂
    this.bindViewEvents();
  }

  /**
   * Á∂ÅÂÆöË°®ÂñÆ‰∫ã‰ª∂
   */
  bindFormEvents() {
    if (this.elements.taskForm) {
      this.elements.taskForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleTaskSubmit();
      });
    }

    if (this.elements.clearFormBtn) {
      this.elements.clearFormBtn.addEventListener('click', () => {
        this.clearTaskForm();
      });
    }

    // Ëº∏ÂÖ•È©óË≠â
    if (this.elements.titleInput) {
      this.elements.titleInput.addEventListener('input', (e) => {
        this.validateTitleInput(e.target);
      });
    }
  }

  /**
   * Á∂ÅÂÆöÊêúÂ∞ã‰∫ã‰ª∂
   */
  bindSearchEvents() {
    if (this.elements.searchInput) {
      // ‰ΩøÁî®Èò≤ÊäñÂÑ™ÂåñÊêúÂ∞ãÊÄßËÉΩ
      const debouncedSearch = this.utils.debounce((query) => {
        this.handleSearch(query);
      }, 300);

      this.elements.searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        this.searchQuery = query;

        // È°ØÁ§∫/Èö±ËóèÊ∏ÖÈô§ÊåâÈàï
        if (this.elements.searchClearBtn) {
          this.elements.searchClearBtn.style.display = query ? 'block' : 'none';
        }

        debouncedSearch(query);
      });
    }

    if (this.elements.searchClearBtn) {
      this.elements.searchClearBtn.addEventListener('click', () => {
        this.clearSearch();
      });
    }
  }

  /**
   * Á∂ÅÂÆöÁØ©ÈÅ∏‰∫ã‰ª∂
   */
  bindFilterEvents() {
    this.elements.filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const filter = button.dataset.filter;
        this.setActiveFilter(filter);
      });
    });
  }

  /**
   * Á∂ÅÂÆöÊéíÂ∫è‰∫ã‰ª∂
   */
  bindSortEvents() {
    if (this.elements.sortSelect) {
      this.elements.sortSelect.addEventListener('change', (e) => {
        this.currentSort = e.target.value;
        this.notifyListeners('sortChanged', this.currentSort);
      });
    }
  }

  /**
   * Á∂ÅÂÆöÊâπÈáèÊìç‰Ωú‰∫ã‰ª∂
   */
  bindBulkActionEvents() {
    if (this.elements.selectAllBtn) {
      this.elements.selectAllBtn.addEventListener('click', () => {
        this.toggleSelectAll();
      });
    }

    if (this.elements.markCompleteBtn) {
      this.elements.markCompleteBtn.addEventListener('click', () => {
        this.markSelectedAsCompleted();
      });
    }

    if (this.elements.deleteSelectedBtn) {
      this.elements.deleteSelectedBtn.addEventListener('click', () => {
        this.deleteSelectedTasks();
      });
    }
  }

  /**
   * Á∂ÅÂÆöÊ®°ÊÖãÊ°Ü‰∫ã‰ª∂
   */
  bindModalEvents() {
    if (this.elements.confirmModalClose) {
      this.elements.confirmModalClose.addEventListener('click', () => {
        this.hideModal();
      });
    }

    if (this.elements.confirmModalCancel) {
      this.elements.confirmModalCancel.addEventListener('click', () => {
        this.hideModal();
      });
    }

    // ÈªûÊìäËÉåÊôØÈóúÈñâÊ®°ÊÖãÊ°Ü
    if (this.elements.confirmModal) {
      this.elements.confirmModal.addEventListener('click', (e) => {
        if (e.target === this.elements.confirmModal) {
          this.hideModal();
        }
      });
    }
  }

  /**
   * Á∂ÅÂÆöÈçµÁõ§‰∫ã‰ª∂
   */
  bindKeyboardEvents() {
    document.addEventListener('keydown', (e) => {
      // Escape ÈçµËôïÁêÜ
      if (e.key === 'Escape') {
        if (this.isModalVisible()) {
          this.hideModal();
        } else if (this.searchQuery) {
          this.clearSearch();
        }
      }
    });
  }

  /**
   * Á∂ÅÂÆöË¶ñÂúñÂàáÊèõ‰∫ã‰ª∂
   */
  bindViewEvents() {
    this.elements.viewButtons.forEach(button => {
      button.addEventListener('click', () => {
        const view = button.dataset.view;
        this.setViewMode(view);
      });
    });
  }

  /**
   * ÊáâÁî®ÂàùÂßãË®≠ÂÆö
   */
  applyInitialSettings() {
    // Ë®≠ÂÆöÈ†êË®≠ÊéíÂ∫èÊñπÂºè
    const defaultSort = this.settings.get('tasks.defaultSortBy', 'created-desc');
    this.currentSort = defaultSort;
    if (this.elements.sortSelect) {
      this.elements.sortSelect.value = defaultSort;
    }

    // Ë®≠ÂÆöÈ†êË®≠Ë¶ñÂúñÊ®°Âºè
    const defaultView = this.settings.get('ui.viewMode', 'list');
    this.setViewMode(defaultView);

    // Ë®≠ÂÆöÂãïÁï´
    const animationsEnabled = this.settings.get('ui.animations', true);
    this.toggleAnimations(animationsEnabled);
  }

  /**
   * Á∂ÅÂÆöË®≠ÂÆöÁõ£ËÅΩÂô®
   */
  bindSettingsListeners() {
    this.settings.onChange('ui.animations', (enabled) => {
      this.toggleAnimations(enabled);
    });

    this.settings.onChange('ui.viewMode', (viewMode) => {
      this.setViewMode(viewMode);
    });
  }

  /**
   * ========== ‰ªªÂãôËº∏ÂÖ•ËôïÁêÜ ==========
   */

  /**
   * ËôïÁêÜ‰ªªÂãôÊèê‰∫§
   */
  async handleTaskSubmit() {
    if (!this.components.taskInput.validate()) {
      return;
    }

    const taskData = this.components.taskInput.getTaskData();

    try {
      // ÈÄöÁü•ÂÑ≤Â≠òÊ®°ÁµÑÊ∑ªÂä†‰ªªÂãô
      this.notifyListeners('taskAddRequested', taskData);

      // Ê∏ÖÁ©∫Ë°®ÂñÆ
      this.clearTaskForm();

      // È°ØÁ§∫ÊàêÂäüÈÄöÁü•
      this.showNotification('‰ªªÂãôÊ∑ªÂä†ÊàêÂäü', 'success');

    } catch (error) {
      console.error('Ê∑ªÂä†‰ªªÂãôÂ§±Êïó:', error);
      this.showNotification('Ê∑ªÂä†‰ªªÂãôÂ§±ÊïóÔºåË´ãÈáçË©¶', 'error');
    }
  }

  /**
   * Ê∏ÖÁ©∫‰ªªÂãôË°®ÂñÆ
   */
  clearTaskForm() {
    this.components.taskInput.clear();

    // Ê∏ÖÈô§ÈåØË™§ÁãÄÊÖã
    this.clearFormErrors();
  }

  /**
   * Ê∏ÖÈô§Ë°®ÂñÆÈåØË™§
   */
  clearFormErrors() {
    const errorElements = this.elements.taskForm.querySelectorAll('.has-error');
    errorElements.forEach(element => {
      element.classList.remove('has-error');
    });

    const errorMessages = this.elements.taskForm.querySelectorAll('.error-message');
    errorMessages.forEach(element => {
      element.textContent = '';
    });
  }

  /**
   * È©óË≠âÊ®ôÈ°åËº∏ÂÖ•
   * @param {HTMLInputElement} input - Ëº∏ÂÖ•ÂÖÉÁ¥†
   */
  validateTitleInput(input) {
    const validation = this.utils.validateTaskTitle(input.value);
    const formGroup = input.closest('.form-group');
    const errorElement = formGroup.querySelector('.error-message');

    if (validation.isValid) {
      formGroup.classList.remove('has-error');
      errorElement.textContent = '';
    } else {
      formGroup.classList.add('has-error');
      errorElement.textContent = validation.message;
    }

    return validation.isValid;
  }

  /**
   * ========== ÊêúÂ∞ãÂíåÁØ©ÈÅ∏ËôïÁêÜ ==========
   */

  /**
   * ËôïÁêÜÊêúÂ∞ã
   * @param {string} query - ÊêúÂ∞ãÊü•Ë©¢
   */
  handleSearch(query) {
    this.notifyListeners('searchChanged', {
      query,
      filter: this.currentFilter,
      sort: this.currentSort
    });
  }

  /**
   * Ê∏ÖÈô§ÊêúÂ∞ã
   */
  clearSearch() {
    if (this.elements.searchInput) {
      this.elements.searchInput.value = '';
    }
    this.searchQuery = '';

    if (this.elements.searchClearBtn) {
      this.elements.searchClearBtn.style.display = 'none';
    }

    this.handleSearch('');
  }

  /**
   * Ë®≠ÂÆöÊ¥ªÂãïÁØ©ÈÅ∏Âô®
   * @param {string} filter - ÁØ©ÈÅ∏Âô®È°ûÂûã
   */
  setActiveFilter(filter) {
    this.currentFilter = filter;

    // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
    this.elements.filterButtons.forEach(button => {
      const isActive = button.dataset.filter === filter;
      button.classList.toggle('active', isActive);
      button.setAttribute('aria-selected', isActive);
    });

    // ÈÄöÁü•ÂÖ∂‰ªñÁµÑ‰ª∂
    this.notifyListeners('filterChanged', {
      filter,
      query: this.searchQuery,
      sort: this.currentSort
    });
  }

  /**
   * ========== ‰ªªÂãôÂàóË°®ÁÆ°ÁêÜ ==========
   */

  /**
   * Ê∏≤Êüì‰ªªÂãôÂàóË°®
   * @param {Array} tasks - ‰ªªÂãôÈô£Âàó
   */
  renderTasks(tasks) {
    this.components.taskList.render(tasks);

    // Êõ¥Êñ∞Áµ±Ë®àË≥áË®ä
    this.updateTaskStats(tasks);

    // Êõ¥Êñ∞ÁØ©ÈÅ∏Ë®àÊï∏
    this.updateFilterCounts();

    // È°ØÁ§∫/Èö±ËóèÁ©∫ÁãÄÊÖã
    this.toggleEmptyState(tasks.length === 0);
  }

  /**
   * Êõ¥Êñ∞‰ªªÂãôÁµ±Ë®à
   * @param {Array} tasks - ‰ªªÂãôÈô£Âàó
   */
  updateTaskStats(tasks) {
    const total = tasks.length;
    const completed = tasks.filter(task => task.status === 'completed').length;

    if (this.elements.totalTasksCount) {
      this.elements.totalTasksCount.textContent = total;
    }

    if (this.elements.completedTasksCount) {
      this.elements.completedTasksCount.textContent = completed;
    }
  }

  /**
   * Êõ¥Êñ∞ÁØ©ÈÅ∏Ë®àÊï∏
   */
  updateFilterCounts() {
    // ÈÄôÈúÄË¶ÅÂæûÂÑ≤Â≠òÊ®°ÁµÑÁç≤ÂèñÂØ¶ÈöõÊï∏Êìö
    this.notifyListeners('requestFilterCounts');
  }

  /**
   * Ë®≠ÂÆöÁØ©ÈÅ∏Ë®àÊï∏
   * @param {Object} counts - Ë®àÊï∏Â∞çË±°
   */
  setFilterCounts(counts) {
    if (this.elements.filterCounts.all) {
      this.elements.filterCounts.all.textContent = counts.all;
    }
    if (this.elements.filterCounts.active) {
      this.elements.filterCounts.active.textContent = counts.active;
    }
    if (this.elements.filterCounts.completed) {
      this.elements.filterCounts.completed.textContent = counts.completed;
    }
  }

  /**
   * ÂàáÊèõÁ©∫ÁãÄÊÖãÈ°ØÁ§∫
   * @param {boolean} show - ÊòØÂê¶È°ØÁ§∫
   */
  toggleEmptyState(show) {
    const hasSearch = this.searchQuery.length > 0;

    if (show && !hasSearch) {
      // È°ØÁ§∫Á©∫ÁãÄÊÖã
      if (this.elements.emptyState) {
        this.elements.emptyState.style.display = 'block';
      }
      if (this.elements.noResults) {
        this.elements.noResults.style.display = 'none';
      }
    } else if (show && hasSearch) {
      // È°ØÁ§∫ÁÑ°ÊêúÂ∞ãÁµêÊûú
      if (this.elements.emptyState) {
        this.elements.emptyState.style.display = 'none';
      }
      if (this.elements.noResults) {
        this.elements.noResults.style.display = 'block';
      }
    } else {
      // Èö±ËóèÊâÄÊúâÁ©∫ÁãÄÊÖã
      if (this.elements.emptyState) {
        this.elements.emptyState.style.display = 'none';
      }
      if (this.elements.noResults) {
        this.elements.noResults.style.display = 'none';
      }
    }
  }

  /**
   * ========== Ë¶ñÂúñÁÆ°ÁêÜ ==========
   */

  /**
   * Ë®≠ÂÆöË¶ñÂúñÊ®°Âºè
   * @param {string} mode - Ë¶ñÂúñÊ®°Âºè ('list' Êàñ 'grid')
   */
  setViewMode(mode) {
    // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
    this.elements.viewButtons.forEach(button => {
      const isActive = button.dataset.view === mode;
      button.classList.toggle('active', isActive);
    });

    // Êõ¥Êñ∞ÂàóË°®Ê®£Âºè
    if (this.elements.taskList) {
      this.elements.taskList.className = `task-list view-${mode}`;
    }

    // ÂÑ≤Â≠òË®≠ÂÆö
    this.settings.set('ui.viewMode', mode);
  }

  /**
   * ========== ÊâπÈáèÊìç‰Ωú ==========
   */

  /**
   * ÂàáÊèõÈÅ∏ÂèñÊâÄÊúâ‰ªªÂãô
   */
  toggleSelectAll() {
    const allTasks = this.components.taskList.getAllTaskElements();
    const allSelected = this.selectedTasks.size === allTasks.length;

    if (allSelected) {
      // ÂèñÊ∂àÈÅ∏ÂèñÊâÄÊúâ
      this.clearSelection();
    } else {
      // ÈÅ∏ÂèñÊâÄÊúâ
      this.selectAllTasks();
    }

    this.updateBulkActionsUI();
  }

  /**
   * ÈÅ∏ÂèñÊâÄÊúâ‰ªªÂãô
   */
  selectAllTasks() {
    const allTasks = this.components.taskList.getAllTaskElements();
    allTasks.forEach(taskElement => {
      const taskId = taskElement.dataset.taskId;
      if (taskId) {
        this.selectedTasks.add(taskId);
        taskElement.classList.add('selected');
      }
    });
  }

  /**
   * Ê∏ÖÈô§ÈÅ∏Âèñ
   */
  clearSelection() {
    this.selectedTasks.clear();
    const selectedElements = this.elements.taskList.querySelectorAll('.task-item.selected');
    selectedElements.forEach(element => {
      element.classList.remove('selected');
    });
  }

  /**
   * ÂàáÊèõ‰ªªÂãôÈÅ∏ÂèñÁãÄÊÖã
   * @param {string} taskId - ‰ªªÂãô ID
   * @param {HTMLElement} taskElement - ‰ªªÂãôÂÖÉÁ¥†
   */
  toggleTaskSelection(taskId, taskElement) {
    if (this.selectedTasks.has(taskId)) {
      this.selectedTasks.delete(taskId);
      taskElement.classList.remove('selected');
    } else {
      this.selectedTasks.add(taskId);
      taskElement.classList.add('selected');
    }

    this.updateBulkActionsUI();
  }

  /**
   * Êõ¥Êñ∞ÊâπÈáèÊìç‰Ωú UI
   */
  updateBulkActionsUI() {
    const hasSelection = this.selectedTasks.size > 0;

    if (this.elements.bulkActions) {
      this.elements.bulkActions.style.display = hasSelection ? 'block' : 'none';
    }

    if (this.elements.selectedCount) {
      this.elements.selectedCount.textContent = this.selectedTasks.size;
    }

    // Êõ¥Êñ∞ÂÖ®ÈÅ∏ÊåâÈàïÊñáÂ≠ó
    if (this.elements.selectAllBtn) {
      const allTasks = this.components.taskList.getAllTaskElements();
      const allSelected = this.selectedTasks.size === allTasks.length && allTasks.length > 0;
      this.elements.selectAllBtn.textContent = allSelected ? 'ÂèñÊ∂àÂÖ®ÈÅ∏' : 'ÂÖ®ÈÅ∏';
    }
  }

  /**
   * Ê®ôË®òÈÅ∏ÂèñÁöÑ‰ªªÂãôÁÇ∫Â∑≤ÂÆåÊàê
   */
  markSelectedAsCompleted() {
    if (this.selectedTasks.size === 0) return;

    const taskIds = Array.from(this.selectedTasks);
    this.notifyListeners('tasksStatusUpdateRequested', {
      taskIds,
      status: 'completed'
    });

    this.clearSelection();
    this.updateBulkActionsUI();
  }

  /**
   * Âà™Èô§ÈÅ∏ÂèñÁöÑ‰ªªÂãô
   */
  deleteSelectedTasks() {
    if (this.selectedTasks.size === 0) return;

    this.showConfirmDialog(
      'Á¢∫Ë™çÂà™Èô§',
      `Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÅ∏ÂèñÁöÑ ${this.selectedTasks.size} È†Ö‰ªªÂãôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`,
      () => {
        const taskIds = Array.from(this.selectedTasks);
        this.notifyListeners('tasksDeleteRequested', taskIds);
        this.clearSelection();
        this.updateBulkActionsUI();
      }
    );
  }

  /**
   * ========== Ê®°ÊÖãÊ°ÜÁÆ°ÁêÜ ==========
   */

  /**
   * È°ØÁ§∫Á¢∫Ë™çÂ∞çË©±Ê°Ü
   * @param {string} title - Ê®ôÈ°å
   * @param {string} description - ÊèèËø∞
   * @param {Function} onConfirm - Á¢∫Ë™çÂõûË™ø
   * @param {Function} onCancel - ÂèñÊ∂àÂõûË™ø
   */
  showConfirmDialog(title, description, onConfirm, onCancel = null) {
    if (!this.elements.confirmModal) return;

    // Ë®≠ÂÆöÂÖßÂÆπ
    if (this.elements.confirmModalTitle) {
      this.elements.confirmModalTitle.textContent = title;
    }
    if (this.elements.confirmModalDescription) {
      this.elements.confirmModalDescription.textContent = description;
    }

    // Á∂ÅÂÆö‰∫ã‰ª∂
    const confirmHandler = () => {
      this.hideModal();
      if (onConfirm) onConfirm();
    };

    const cancelHandler = () => {
      this.hideModal();
      if (onCancel) onCancel();
    };

    // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
    if (this.elements.confirmModalConfirm) {
      this.elements.confirmModalConfirm.replaceWith(
        this.elements.confirmModalConfirm.cloneNode(true)
      );
      this.elements.confirmModalConfirm = document.getElementById('confirmModalConfirm');
      this.elements.confirmModalConfirm.addEventListener('click', confirmHandler);
    }

    if (this.elements.confirmModalCancel) {
      this.elements.confirmModalCancel.replaceWith(
        this.elements.confirmModalCancel.cloneNode(true)
      );
      this.elements.confirmModalCancel = document.getElementById('confirmModalCancel');
      this.elements.confirmModalCancel.addEventListener('click', cancelHandler);
    }

    // È°ØÁ§∫Ê®°ÊÖãÊ°Ü
    this.elements.confirmModal.setAttribute('aria-hidden', 'false');
    this.elements.confirmModal.querySelector('.modal').focus();
  }

  /**
   * Èö±ËóèÊ®°ÊÖãÊ°Ü
   */
  hideModal() {
    if (this.elements.confirmModal) {
      this.elements.confirmModal.setAttribute('aria-hidden', 'true');
    }
  }

  /**
   * Ê™¢Êü•Ê®°ÊÖãÊ°ÜÊòØÂê¶ÂèØË¶ã
   * @returns {boolean}
   */
  isModalVisible() {
    return this.elements.confirmModal &&
           this.elements.confirmModal.getAttribute('aria-hidden') === 'false';
  }

  /**
   * ========== ÈÄöÁü•Á≥ªÁµ± ==========
   */

  /**
   * È°ØÁ§∫ÈÄöÁü•
   * @param {string} message - Ë®äÊÅØ
   * @param {string} type - È°ûÂûã ('success', 'error', 'warning', 'info')
   * @param {string} title - Ê®ôÈ°åÔºàÂèØÈÅ∏Ôºâ
   */
  showNotification(message, type = 'info', title = null) {
    this.components.notifications.show(message, type, title);
  }

  /**
   * ========== ÂãïÁï´ÂíåÊïàÊûú ==========
   */

  /**
   * ÂàáÊèõÂãïÁï´
   * @param {boolean} enabled - ÊòØÂê¶ÂïüÁî®
   */
  toggleAnimations(enabled) {
    const root = document.documentElement;
    if (enabled) {
      root.style.removeProperty('--transition-duration');
    } else {
      root.style.setProperty('--transition-duration', '0s');
    }
  }

  /**
   * ========== ‰∫ã‰ª∂Á≥ªÁµ± ==========
   */

  /**
   * Áõ£ËÅΩ UI ‰∫ã‰ª∂
   * @param {string} event - ‰∫ã‰ª∂ÂêçÁ®±
   * @param {Function} callback - ÂõûË™øÂáΩÊï∏
   * @returns {Function} ÂèñÊ∂àÁõ£ËÅΩÁöÑÂáΩÊï∏
   */
  on(event, callback) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set());
    }

    this.listeners.get(event).add(callback);

    return () => {
      const eventListeners = this.listeners.get(event);
      if (eventListeners) {
        eventListeners.delete(callback);
        if (eventListeners.size === 0) {
          this.listeners.delete(event);
        }
      }
    };
  }

  /**
   * ÈÄöÁü•‰∫ã‰ª∂Áõ£ËÅΩÂô®
   * @param {string} event - ‰∫ã‰ª∂ÂêçÁ®±
   * @param {...*} args - ‰∫ã‰ª∂ÂèÉÊï∏
   */
  notifyListeners(event, ...args) {
    if (this.listeners.has(event)) {
      this.listeners.get(event).forEach(callback => {
        try {
          callback(...args);
        } catch (error) {
          console.error(`UI ‰∫ã‰ª∂Áõ£ËÅΩÂô®Âü∑Ë°åÂ§±Êïó (${event}):`, error);
        }
      });
    }
  }

  /**
   * ========== Ê∏ÖÁêÜË≥áÊ∫ê ==========
   */

  /**
   * Ê∏ÖÁêÜ UI Ê®°ÁµÑ
   */
  destroy() {
    this.listeners.clear();
    this.selectedTasks.clear();

    // Ê∏ÖÁêÜÁµÑ‰ª∂
    Object.values(this.components).forEach(component => {
      if (component.destroy) {
        component.destroy();
      }
    });

    console.log('üßπ UI Ê®°ÁµÑÂ∑≤Ê∏ÖÁêÜ');
  }
}

/**
 * ‰ªªÂãôËº∏ÂÖ•ÁµÑ‰ª∂
 */
class TaskInput {
  constructor(elements, utils) {
    this.elements = elements;
    this.utils = utils;
  }

  validate() {
    let isValid = true;

    // È©óË≠âÊ®ôÈ°å
    if (this.elements.titleInput) {
      const titleValidation = this.utils.validateTaskTitle(this.elements.titleInput.value);
      if (!titleValidation.isValid) {
        const formGroup = this.elements.titleInput.closest('.form-group');
        formGroup.classList.add('has-error');
        const errorElement = formGroup.querySelector('.error-message');
        if (errorElement) {
          errorElement.textContent = titleValidation.message;
        }
        isValid = false;
      }
    }

    return isValid;
  }

  getTaskData() {
    const tags = this.elements.tagsInput.value
      .split(',')
      .map(tag => tag.trim())
      .filter(tag => tag.length > 0);

    return {
      title: this.elements.titleInput.value.trim(),
      description: this.elements.descriptionInput.value.trim(),
      priority: this.elements.prioritySelect.value,
      dueDate: this.elements.dueDateInput.value || null,
      tags
    };
  }

  clear() {
    if (this.elements.taskForm) {
      this.elements.taskForm.reset();
    }
    this.clearErrors();
  }

  clearErrors() {
    const errorGroups = this.elements.taskForm.querySelectorAll('.form-group.has-error');
    errorGroups.forEach(group => {
      group.classList.remove('has-error');
    });

    const errorMessages = this.elements.taskForm.querySelectorAll('.error-message');
    errorMessages.forEach(message => {
      message.textContent = '';
    });
  }
}

/**
 * ‰ªªÂãôÂàóË°®ÁµÑ‰ª∂
 */
class TaskList {
  constructor(elements, utils) {
    this.elements = elements;
    this.utils = utils;
  }

  render(tasks) {
    if (!this.elements.taskList) return;

    this.elements.taskList.innerHTML = '';

    tasks.forEach(task => {
      const taskElement = this.createTaskElement(task);
      this.elements.taskList.appendChild(taskElement);
    });
  }

  createTaskElement(task) {
    const li = document.createElement('li');
    li.className = 'task-item';
    li.dataset.taskId = task.id;

    if (task.status === 'completed') {
      li.classList.add('completed');
    }

    // Ë§áÈÅ∏Ê°Ü
    const checkbox = document.createElement('div');
    checkbox.className = 'task-checkbox';
    if (task.status === 'completed') {
      checkbox.classList.add('checked');
    }
    checkbox.setAttribute('role', 'checkbox');
    checkbox.setAttribute('aria-checked', task.status === 'completed');
    checkbox.setAttribute('tabindex', '0');

    // ÂÖßÂÆπ
    const content = document.createElement('div');
    content.className = 'task-content';

    // Ê®ôÈ°å
    const title = document.createElement('div');
    title.className = 'task-title';
    title.textContent = task.title;

    content.appendChild(title);

    // ÊèèËø∞
    if (task.description) {
      const description = document.createElement('div');
      description.className = 'task-description';
      description.textContent = this.utils.truncateString(task.description, 100);
      content.appendChild(description);
    }

    // ÂÖÉÊï∏Êìö
    const meta = document.createElement('div');
    meta.className = 'task-meta';

    // ÂÑ™ÂÖàÁ¥ö
    const priority = document.createElement('span');
    priority.className = `task-priority ${task.priority}`;
    priority.textContent = this.getPriorityLabel(task.priority);
    meta.appendChild(priority);

    // Êà™Ê≠¢Êó•Êúü
    if (task.dueDate) {
      const dueDate = document.createElement('span');
      dueDate.className = 'task-due-date';
      dueDate.textContent = this.utils.formatRelativeTime(task.dueDate);
      meta.appendChild(dueDate);
    }

    // Ê®ôÁ±§
    if (task.tags && task.tags.length > 0) {
      const tags = document.createElement('div');
      tags.className = 'task-tags';

      task.tags.slice(0, 3).forEach(tag => {
        const tagElement = document.createElement('span');
        tagElement.className = 'task-tag';
        tagElement.textContent = tag;
        tags.appendChild(tagElement);
      });

      meta.appendChild(tags);
    }

    content.appendChild(meta);

    // Êìç‰ΩúÊåâÈàï
    const actions = document.createElement('div');
    actions.className = 'task-actions';

    const editBtn = document.createElement('button');
    editBtn.className = 'task-action-btn';
    editBtn.textContent = '‚úèÔ∏è';
    editBtn.setAttribute('aria-label', 'Á∑®ËºØ‰ªªÂãô');

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'task-action-btn delete';
    deleteBtn.textContent = 'üóëÔ∏è';
    deleteBtn.setAttribute('aria-label', 'Âà™Èô§‰ªªÂãô');

    actions.appendChild(editBtn);
    actions.appendChild(deleteBtn);

    li.appendChild(checkbox);
    li.appendChild(content);
    li.appendChild(actions);

    return li;
  }

  getPriorityLabel(priority) {
    const labels = {
      high: 'üî¥ È´ò',
      medium: 'üü° ‰∏≠',
      low: 'üü¢ ‰Ωé'
    };
    return labels[priority] || 'üü° ‰∏≠';
  }

  getAllTaskElements() {
    return Array.from(this.elements.taskList.querySelectorAll('.task-item'));
  }
}

/**
 * ÊéßÂà∂ÁµÑ‰ª∂
 */
class Controls {
  constructor(elements, utils) {
    this.elements = elements;
    this.utils = utils;
  }
}

/**
 * ÈÄöÁü•ÁµÑ‰ª∂
 */
class Notifications {
  constructor(container) {
    this.container = container;
  }

  show(message, type = 'info', title = null) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;

    const icon = document.createElement('div');
    icon.className = 'notification-icon';
    icon.textContent = this.getIcon(type);

    const content = document.createElement('div');
    content.className = 'notification-content';

    if (title) {
      const titleElement = document.createElement('div');
      titleElement.className = 'notification-title';
      titleElement.textContent = title;
      content.appendChild(titleElement);
    }

    const messageElement = document.createElement('div');
    messageElement.className = 'notification-message';
    messageElement.textContent = message;
    content.appendChild(messageElement);

    const closeBtn = document.createElement('button');
    closeBtn.className = 'notification-close';
    closeBtn.setAttribute('aria-label', 'ÈóúÈñâÈÄöÁü•');
    closeBtn.textContent = '‚úï';

    closeBtn.addEventListener('click', () => {
      notification.style.animation = 'slideOutRight 0.3s ease-out';
      setTimeout(() => notification.remove(), 300);
    });

    notification.appendChild(icon);
    notification.appendChild(content);
    notification.appendChild(closeBtn);

    this.container.appendChild(notification);

    // Ëá™ÂãïÁßªÈô§
    setTimeout(() => {
      if (notification.parentNode) {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }
    }, 3000);
  }

  getIcon(type) {
    const icons = {
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      info: '‚ÑπÔ∏è'
    };
    return icons[type] || icons.info;
  }
}