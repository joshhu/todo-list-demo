<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>瀏覽器兼容性測試 - Todo List</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .test-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }

        .test-button:hover {
            background: #218838;
        }

        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .result-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .result-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .score-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .score-high { color: #28a745; }
        .score-medium { color: #ffc107; }
        .score-low { color: #dc3545; }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .feature-item {
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .feature-supported {
            background: #d4edda;
            color: #155724;
        }

        .feature-not-supported {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <header class="test-header">
            <h1>🌐 瀏覽器兼容性測試</h1>
            <p>檢測您的瀏覽器對 Todo List 應用程式的支援程度</p>
        </header>

        <main>
            <section class="test-section">
                <h2>🚀 開始測試</h2>
                <p>點擊下面的按鈕開始完整的瀏覽器兼容性測試：</p>
                <button id="runTestBtn" class="test-button">執行完整測試</button>
                <button id="quickTestBtn" class="test-button">快速檢查</button>
                <div id="loadingIndicator" class="loading" style="display: none;">
                    測試進行中
                </div>
            </section>

            <section id="resultsSection" class="test-section" style="display: none;">
                <h2>📊 測試結果</h2>
                <div id="scoreDisplay" class="score-display"></div>
                <div id="browserInfo" class="result-container result-info"></div>

                <h3>🔧 功能支援檢查</h3>
                <div id="featuresResult" class="feature-grid"></div>

                <h3>🎨 CSS 支援檢查</h3>
                <div id="cssResult" class="feature-grid"></div>

                <h3>♿ 無障礙功能支援</h3>
                <div id="accessibilityResult" class="feature-grid"></div>

                <h3>⚡ 性能測試</h3>
                <div id="performanceResult" class="result-container result-info"></div>

                <h3>💡 改進建議</h3>
                <div id="recommendationsResult" class="result-container result-info"></div>
            </section>

            <section class="test-section">
                <h2>🔍 瀏覽器支援矩陣</h2>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">瀏覽器</th>
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">最低版本</th>
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">推薦版本</th>
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">支援狀態</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 12px;">Chrome</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">90+</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">最新版本</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center; color: #28a745;">✅ 完全支援</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 12px;">Firefox</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">88+</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">最新版本</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center; color: #28a745;">✅ 完全支援</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 12px;">Safari</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">14+</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">最新版本</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center; color: #ffc107;">⚠️ 部分功能</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 12px;">Edge</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">90+</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">最新版本</td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center; color: #28a745;">✅ 完全支援</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section class="test-section">
                <h2>📱 行動裝置支援</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div>
                        <h4>iOS Safari</h4>
                        <ul>
                            <li>iOS 14+ 基本支援</li>
                            <li>iOS 15+ 完整支援</li>
                            <li>建議使用 iOS 15 或更新版本</li>
                        </ul>
                    </div>
                    <div>
                        <h4>Android Chrome</h4>
                        <ul>
                            <li>Android 10+ 基本支援</li>
                            <li>Android 12+ 完整支援</li>
                            <li>建議使用 Android 12 或更新版本</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="tests/browser-compatibility-test.js"></script>
    <script>
        // DOM 元素
        const runTestBtn = document.getElementById('runTestBtn');
        const quickTestBtn = document.getElementById('quickTestBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsSection = document.getElementById('resultsSection');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const browserInfo = document.getElementById('browserInfo');
        const featuresResult = document.getElementById('featuresResult');
        const cssResult = document.getElementById('cssResult');
        const accessibilityResult = document.getElementById('accessibilityResult');
        const performanceResult = document.getElementById('performanceResult');
        const recommendationsResult = document.getElementById('recommendationsResult');

        // 創建測試實例
        const compatibilityTest = new BrowserCompatibilityTest();

        // 事件監聽器
        runTestBtn.addEventListener('click', runFullTest);
        quickTestBtn.addEventListener('click', runQuickTest);

        /**
         * 執行完整測試
         */
        async function runFullTest() {
            showLoading(true);
            hideResults();

            try {
                console.log('開始執行完整瀏覽器兼容性測試...');
                const results = await compatibilityTest.runFullTest();
                displayResults(results);
                console.log('測試完成:', results);
            } catch (error) {
                console.error('測試執行錯誤:', error);
                displayError('測試執行失敗: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        /**
         * 執行快速測試
         */
        async function runQuickTest() {
            showLoading(true);
            hideResults();

            try {
                console.log('開始執行快速兼容性檢查...');

                // 只檢查基本功能，不執行性能測試
                const browserInfo = BrowserDetector.getBrowserInfo();
                const features = FeatureDetector.checkBasicAPIs();
                const css = FeatureDetector.checkCSSFeatures();
                const accessibility = FeatureDetector.checkAccessibilityFeatures();

                const quickResults = {
                    browser: { ...browserInfo, version: BrowserDetector.getBrowserVersion() },
                    features,
                    css,
                    accessibility,
                    performance: null
                };

                displayQuickResults(quickResults);
                console.log('快速檢查完成:', quickResults);
            } catch (error) {
                console.error('快速檢查錯誤:', error);
                displayError('快速檢查失敗: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        /**
         * 安全地創建元素並設置文本內容
         */
        function safeCreateElement(tag, textContent, className) {
            const element = document.createElement(tag);
            if (textContent) {
                element.textContent = textContent;
            }
            if (className) {
                element.className = className;
            }
            return element;
        }

        /**
         * 安全地清除元素內容
         */
        function safeClearElement(element) {
            while (element.firstChild) {
                element.removeChild(element.firstChild);
            }
        }

        /**
         * 顯示完整測試結果
         */
        function displayResults(results) {
            const summary = compatibilityTest.generateSummary();

            // 安全地顯示分數
            safeClearElement(scoreDisplay);
            const scoreClass = summary.overallScore >= 90 ? 'score-high' :
                             summary.overallScore >= 70 ? 'score-medium' : 'score-low';

            const scoreMain = safeCreateElement('div', `總體評分: ${summary.overallScore}%`, scoreClass);
            scoreDisplay.appendChild(scoreMain);

            const scoreDetails = safeCreateElement('div',
                `功能支援: ${summary.featureSupport.score}% | CSS支援: ${summary.cssSupport.score}% | 無障礙: ${summary.accessibilitySupport.score}%`,
                ''
            );
            scoreDetails.style.fontSize = '14px';
            scoreDetails.style.color = '#666';
            scoreDetails.style.marginTop = '10px';
            scoreDisplay.appendChild(scoreDetails);

            // 安全地顯示瀏覽器資訊
            browserInfo.textContent = `瀏覽器: ${summary.browser} | 平台: ${summary.platform} | 設備: ${summary.isMobile ? '行動裝置' : '桌面裝置'}`;

            // 顯示功能支援
            displayFeatureGrid(featuresResult, results.features);

            // 顯示 CSS 支援
            displayFeatureGrid(cssResult, results.css);

            // 顯示無障礙支援
            displayFeatureGrid(accessibilityResult, results.accessibility);

            // 顯示性能結果
            displayPerformanceResults(results.performance);

            // 顯示建議
            displayRecommendations(compatibilityTest.generateRecommendations());

            showResults();
        }

        /**
         * 顯示快速測試結果
         */
        function displayQuickResults(results) {
            const featureCount = Object.values(results.features).filter(Boolean).length;
            const totalFeatures = Object.keys(results.features).length;
            const score = Math.round((featureCount / totalFeatures) * 100);

            safeClearElement(scoreDisplay);
            const scoreClass = score >= 90 ? 'score-high' : score >= 70 ? 'score-medium' : 'score-low';

            const scoreMain = safeCreateElement('div', `兼容性評分: ${score}%`, scoreClass);
            scoreDisplay.appendChild(scoreMain);

            const scoreDetails = safeCreateElement('div', `功能支援: ${featureCount}/${totalFeatures}`, '');
            scoreDetails.style.fontSize = '14px';
            scoreDetails.style.color = '#666';
            scoreDetails.style.marginTop = '10px';
            scoreDisplay.appendChild(scoreDetails);

            // 安全地顯示瀏覽器資訊
            const browserName = results.browser.isChrome ? 'Chrome' :
                               results.browser.isFirefox ? 'Firefox' :
                               results.browser.isSafari ? 'Safari' :
                               results.browser.isEdge ? 'Edge' : 'Unknown';
            browserInfo.textContent = `瀏覽器: ${browserName} ${results.browser.version} | 平台: ${results.browser.platform}`;

            // 顯示關鍵功能支援
            displayFeatureGrid(featuresResult, results.features);
            displayFeatureGrid(cssResult, results.css);

            showResults();
        }

        /**
         * 顯示功能網格
         */
        function displayFeatureGrid(container, features) {
            safeClearElement(container);

            for (const [feature, supported] of Object.entries(features)) {
                const item = safeCreateElement(
                    'div',
                    `${feature}: ${supported ? '✅' : '❌'}`,
                    `feature-item ${supported ? 'feature-supported' : 'feature-not-supported'}`
                );
                container.appendChild(item);
            }
        }

        /**
         * 顯示性能結果
         */
        function displayPerformanceResults(performance) {
            if (!performance) {
                performanceResult.textContent = '未執行性能測試';
                return;
            }

            let text = '';

            if (performance.localStorage && !performance.localStorage.error) {
                text += 'localStorage 性能測試:\n';
                for (const [size, data] of Object.entries(performance.localStorage)) {
                    text += `  ${size} 寫入: ${data.writeTime.average.toFixed(3)}ms, 讀取: ${data.readTime.average.toFixed(3)}ms\n`;
                }
            }

            if (performance.dom) {
                text += 'DOM 操作性能:\n';
                text += `  元素創建: ${performance.dom.createElement.average.toFixed(3)}ms\n`;
                text += `  查詢操作: ${performance.dom.querySelector.average.toFixed(3)}ms\n`;
            }

            performanceResult.textContent = text || '性能測試數據不可用';
        }

        /**
         * 顯示建議
         */
        function displayRecommendations(recommendations) {
            safeClearElement(recommendationsResult);

            if (recommendations.length === 0) {
                recommendationsResult.textContent = '🎉 太棒了！沒有發現兼容性問題。';
                return;
            }

            let text = '發現以下兼容性問題和建議:\n\n';

            recommendations.forEach(rec => {
                const icon = rec.type === 'critical' ? '🚨' :
                           rec.type === 'warning' ? '⚠️' : 'ℹ️';
                text += `${icon} ${rec.issue}\n`;
                text += `   解決方案: ${rec.solution}\n\n`;
            });

            recommendationsResult.textContent = text;
        }

        /**
         * 顯示錯誤訊息
         */
        function displayError(message) {
            safeClearElement(scoreDisplay);
            const errorElement = safeCreateElement('div', '測試失敗', 'score-low');
            scoreDisplay.appendChild(errorElement);
            browserInfo.textContent = message;
            showResults();
        }

        /**
         * 顯示/隱藏載入指示器
         */
        function showLoading(show) {
            loadingIndicator.style.display = show ? 'block' : 'none';
            runTestBtn.disabled = show;
            quickTestBtn.disabled = show;
        }

        /**
         * 顯示/隱藏結果區域
         */
        function showResults() {
            resultsSection.style.display = 'block';
        }

        function hideResults() {
            resultsSection.style.display = 'none';
        }

        // 如果已經存在測試結果，自動顯示
        try {
            const savedReport = localStorage.getItem('browserCompatibilityReport');
            if (savedReport) {
                const report = JSON.parse(savedReport);
                console.log('找到保存的測試報告');
                // 可以選擇自動顯示之前的結果
            }
        } catch (e) {
            console.warn('無法讀取保存的測試報告:', e);
        }
    </script>
</body>
</html>